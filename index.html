<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Badminton Money Tracker</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background:#0b1220; color:#e9eefb; }
    header { padding: 16px 18px; background:#0f1b33; position: sticky; top:0; border-bottom:1px solid #203055;}
    h1 { margin:0; font-size: 18px; }
    main { padding: 16px 18px 80px; max-width: 980px; margin: 0 auto; }
    .grid { display: grid; gap: 14px; }
    @media (min-width: 920px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card { background:#0f1b33; border:1px solid #203055; border-radius: 14px; padding: 14px; }
    .card h2 { margin: 0 0 10px; font-size: 16px; }
    label { display:block; font-size:12px; opacity: .9; margin: 10px 0 6px; }
    input, select, textarea, button {
      width:100%; box-sizing:border-box; padding:10px 10px;
      border-radius: 10px; border:1px solid #2a3d6a; background:#0b1220; color:#e9eefb;
    }
    textarea { min-height: 70px; resize: vertical; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .btnrow { display:flex; gap:10px; margin-top: 12px; }
    button { cursor:pointer; font-weight:600; }
    button.primary { background:#2a5bd7; border-color:#2a5bd7; }
    button.danger { background:#c03636; border-color:#c03636; }
    button.ghost { background:transparent; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
    th, td { text-align:left; padding:10px 8px; border-bottom:1px solid #203055; vertical-align: top; }
    th { font-size: 12px; opacity:.9; }
    .pos { color:#5ee38f; font-weight:700; }
    .neg { color:#ff8f8f; font-weight:700; }
    .zero { color:#cbd7ff; font-weight:700; opacity:.9; }
    .muted { opacity:.8; font-size: 12px; }
    .mini { font-size: 12px; opacity:.85; }
    .sep { height:1px; background:#203055; margin: 10px 0; }
    .tag { display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid #2a3d6a; font-size: 12px; opacity:.95; }
    footer {
      position: fixed; left:0; right:0; bottom:0; background:#0f1b33; border-top:1px solid #203055;
      padding: 10px 18px;
    }
    .footer-inner { max-width: 980px; margin: 0 auto; display:flex; gap:10px; }
    .footer-inner button { width:auto; }
    .toast { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); background:#102043; border:1px solid #2a3d6a;
             padding:10px 12px; border-radius: 12px; display:none; }
    .toast.show { display:block; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }

    /* Checkbox roster */
    .checks { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
    .check { display:flex; align-items:center; gap:10px; padding:10px; border-radius:12px; border:1px solid #2a3d6a; background:#0b1220; }
    .check input { width: 18px; height: 18px; }
    .check span { font-size: 14px; }
    @media (min-width: 520px) { .checks { grid-template-columns: 1fr 1fr 1fr; } }
  </style>
</head>
<body>
<header>
  <h1>Badminton Money Tracker <span class="tag">VJ/Dhara payees</span> <span class="tag">Equal split</span></h1>
  <div class="muted">Sessions + payments → auto balances. Data stored locally in your browser.</div>
</header>

<main class="grid">
  <section class="card">
    <h2>Add Session</h2>

    <div class="row">
      <div>
        <label>Date</label>
        <input id="sDate" type="date" />
      </div>
      <div>
        <label>Payer (paid hall)</label>
        <select id="sPayer">
          <option value="">Select…</option>
          <option value="VJ">VJ</option>
          <option value="Dhara">Dhara</option>
        </select>
      </div>
    </div>

    <label>Total cost (£)</label>
    <input id="sTotal" type="number" step="0.01" min="0" placeholder="e.g. 13" />

    <label>Who played? (tick all who played)</label>
    <div id="playersChecks" class="checks"></div>
    <div class="mini">Random attendance is fine. Share is calculated as <span class="code">total ÷ attendees</span>.</div>

    <label>Notes (optional)</label>
    <textarea id="sNotes" placeholder="e.g. Off-peak, 2 courts, etc."></textarea>

    <div class="btnrow">
      <button class="primary" id="addSessionBtn">Add session</button>
      <button class="ghost" id="clearSessionBtn" type="button">Clear</button>
    </div>
  </section>

  <section class="card">
    <h2>Add Payment</h2>

    <div class="row">
      <div>
        <label>Date</label>
        <input id="pDate" type="date" />
      </div>
      <div>
        <label>To (must be VJ or Dhara)</label>
        <select id="pTo">
          <option value="">Select…</option>
          <option value="VJ">VJ</option>
          <option value="Dhara">Dhara</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>From</label>
        <select id="pFrom"></select>
      </div>
      <div>
        <label>Amount (£)</label>
        <input id="pAmt" type="number" step="0.01" min="0" placeholder="e.g. 3.25" />
      </div>
    </div>

    <label>Notes (optional)</label>
    <input id="pNotes" placeholder="e.g. bank transfer" />

    <div class="btnrow">
      <button class="primary" id="addPaymentBtn">Add payment</button>
      <button class="ghost" id="clearPaymentBtn" type="button">Clear</button>
    </div>
  </section>

  <section class="card" style="grid-column: 1 / -1;">
    <h2>Summary (what you actually care about)</h2>
    <div class="muted">Positive means you owe money. Zero means settled.</div>
    <table id="summaryTable">
      <thead>
        <tr>
          <th>Player</th>
          <th>Owes VJ</th>
          <th>Owes Dhara</th>
          <th>Total Owed</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="sep"></div>

    <div class="row">
      <div class="card" style="padding:12px; border-radius:12px;">
        <div class="mini">Suggested next payer (most owing)</div>
        <div id="suggestPayer" style="font-size:18px; font-weight:800;">—</div>
      </div>
      <div class="card" style="padding:12px; border-radius:12px;">
        <div class="mini">Suggested collector (most owed)</div>
        <div id="suggestCollector" style="font-size:18px; font-weight:800;">—</div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Sessions</h2>
    <div class="muted">Tap “Delete” to remove a mistaken entry.</div>
    <table id="sessionsTable">
      <thead>
        <tr><th>Date</th><th>Payer</th><th>Total</th><th>Att.</th><th>Share</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="card">
    <h2>Payments</h2>
    <div class="muted">Only real transfers (From → VJ/Dhara).</div>
    <table id="paymentsTable">
      <thead>
        <tr><th>Date</th><th>From</th><th>To</th><th>Amount</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<footer>
  <div class="footer-inner">
    <button id="exportBtn">Export JSON</button>
    <button id="importBtn">Import JSON</button>
    <button class="danger" id="wipeBtn">Wipe all data</button>
  </div>
</footer>

<div id="toast" class="toast"></div>

<script>
  // --- Config ---
  const PLAYERS = ["VJ","Dhara","Neeta","Dipesh","Nitin","Niks","Paras"];
  const PAYEES = new Set(["VJ","Dhara"]);
  const STORAGE_KEY = "badminton_tracker_v1";

  // --- State ---
  let state = loadState();

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return { sessions: [], payments: [] };
      const parsed = JSON.parse(raw);
      if (!parsed.sessions) parsed.sessions = [];
      if (!parsed.payments) parsed.payments = [];
      return parsed;
    } catch {
      return { sessions: [], payments: [] };
    }
  }
  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  // --- Helpers ---
  const £ = (n) => (Math.round((n + Number.EPSILON)*100)/100).toFixed(2);
  const todayISO = () => new Date().toISOString().slice(0,10);
  function toast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1800);
  }

  function computeBalances() {
    // balances[player] = { VJ: x, Dhara: y } amounts owed (positive means owes)
    const balances = {};
    for (const p of PLAYERS) balances[p] = { VJ: 0, Dhara: 0 };

    // Sessions create debt from each attendee (except the payer) to payer
    for (const s of state.sessions) {
      if (!PAYEES.has(s.payer)) continue;
      const attendees = s.attendees || [];
      if (!attendees.length) continue;
      const share = s.total / attendees.length;

      for (const p of attendees) {
        if (p === s.payer) continue; // payer doesn't owe themselves
        balances[p][s.payer] += share;
      }
    }

    // Payments reduce what the person owes to that payee
    for (const pay of state.payments) {
      if (!PAYEES.has(pay.to)) continue;
      balances[pay.from][pay.to] -= pay.amount;
    }

    // Clamp tiny float noise
    for (const p of PLAYERS) {
      for (const payee of ["VJ","Dhara"]) {
        if (Math.abs(balances[p][payee]) < 0.005) balances[p][payee] = 0;
      }
    }
    return balances;
  }

  // --- Checkbox roster ---
  let selectedPlayers = new Set();

  function renderPlayersChecks() {
    const box = document.getElementById("playersChecks");
    box.innerHTML = "";
    for (const p of PLAYERS) {
      const label = document.createElement("label");
      label.className = "check";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selectedPlayers.has(p);
      cb.onchange = () => {
        if (cb.checked) selectedPlayers.add(p);
        else selectedPlayers.delete(p);
      };

      const text = document.createElement("span");
      text.textContent = p;

      label.appendChild(cb);
      label.appendChild(text);
      box.appendChild(label);
    }
  }

  function renderPaymentsFromOptions() {
    const sel = document.getElementById("pFrom");
    sel.innerHTML = "";
    for (const p of PLAYERS) {
      const opt = document.createElement("option");
      opt.value = p; opt.textContent = p;
      sel.appendChild(opt);
    }
  }

  function renderTables() {
    const balances = computeBalances();

    // Summary table
    const tbody = document.querySelector("#summaryTable tbody");
    tbody.innerHTML = "";
    for (const p of PLAYERS) {
      const owesVJ = balances[p].VJ;
      const owesDh = balances[p].Dhara;
      const total = owesVJ + owesDh;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p}</td>
        <td class="${owesVJ>0?'neg':owesVJ<0?'pos':'zero'}">£${£(owesVJ)}</td>
        <td class="${owesDh>0?'neg':owesDh<0?'pos':'zero'}">£${£(owesDh)}</td>
        <td class="${total>0?'neg':total<0?'pos':'zero'}">£${£(total)}</td>
      `;
      tbody.appendChild(tr);
    }

    // Suggested next payer (most owing)
    const totals = PLAYERS.map(p => ({ p, t: balances[p].VJ + balances[p].Dhara }));
    const mostOwing = totals.filter(x => x.t > 0.005).sort((a,b)=> b.t - a.t)[0];
    document.getElementById("suggestPayer").textContent =
      mostOwing ? `${mostOwing.p} (£${£(mostOwing.t)})` : "—";

    // Suggested collector (most owed: VJ or Dhara)
    const owedToVJ = PLAYERS.reduce((acc,p)=> acc + (balances[p].VJ||0), 0);
    const owedToDh = PLAYERS.reduce((acc,p)=> acc + (balances[p].Dhara||0), 0);
    const collector = owedToVJ >= owedToDh ? {p:"VJ", t:owedToVJ} : {p:"Dhara", t:owedToDh};
    document.getElementById("suggestCollector").textContent =
      (Math.abs(collector.t) > 0.005) ? `${collector.p} (£${£(collector.t)})` : "—";

    // Sessions table
    const sbody = document.querySelector("#sessionsTable tbody");
    sbody.innerHTML = "";
    const sessionsSorted = [...state.sessions].sort((a,b)=> a.date.localeCompare(b.date));
    sessionsSorted.forEach((s) => {
      const share = (s.attendees?.length) ? s.total / s.attendees.length : 0;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${s.date}</td>
        <td>${s.payer}</td>
        <td>£${£(s.total)}</td>
        <td>${s.attendees?.length || 0}</td>
        <td>£${£(share)}</td>
        <td><button class="danger" data-del-session="${s.id}">Delete</button></td>
      `;
      sbody.appendChild(tr);
    });

    // Payments table
    const pbody = document.querySelector("#paymentsTable tbody");
    pbody.innerHTML = "";
    const paymentsSorted = [...state.payments].sort((a,b)=> a.date.localeCompare(b.date));
    paymentsSorted.forEach(pay => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${pay.date}</td>
        <td>${pay.from}</td>
        <td>${pay.to}</td>
        <td>£${£(pay.amount)}</td>
        <td><button class="danger" data-del-payment="${pay.id}">Delete</button></td>
      `;
      pbody.appendChild(tr);
    });

    // Bind delete buttons
    document.querySelectorAll("[data-del-session]").forEach(btn => {
      btn.onclick = () => {
        const id = btn.getAttribute("data-del-session");
        state.sessions = state.sessions.filter(s => s.id !== id);
        saveState(); renderTables(); toast("Session deleted");
      };
    });
    document.querySelectorAll("[data-del-payment]").forEach(btn => {
      btn.onclick = () => {
        const id = btn.getAttribute("data-del-payment");
        state.payments = state.payments.filter(p => p.id !== id);
        saveState(); renderTables(); toast("Payment deleted");
      };
    });
  }

  function render() {
    renderPlayersChecks();
    renderPaymentsFromOptions();
    renderTables();
  }

  // --- Add session ---
  document.getElementById("addSessionBtn").onclick = () => {
    const date = document.getElementById("sDate").value || "";
    const payer = document.getElementById("sPayer").value || "";
    const total = parseFloat(document.getElementById("sTotal").value || "0");
    const notes = document.getElementById("sNotes").value || "";

    if (!date) return toast("Pick a date");
    if (!PAYEES.has(payer)) return toast("Payer must be VJ or Dhara");
    if (!(total > 0)) return toast("Enter a valid total");
    const attendees = [...selectedPlayers];
    if (!attendees.length) return toast("Tick who played");

    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2);
    state.sessions.push({ id, date, payer, total, attendees, notes });
    saveState();

    // reset form
    document.getElementById("sDate").value = "";
    document.getElementById("sPayer").value = "";
    document.getElementById("sTotal").value = "";
    document.getElementById("sNotes").value = "";
    selectedPlayers = new Set();
    renderPlayersChecks();
    renderTables();
    toast("Session added");
  };

  document.getElementById("clearSessionBtn").onclick = () => {
    document.getElementById("sDate").value = "";
    document.getElementById("sPayer").value = "";
    document.getElementById("sTotal").value = "";
    document.getElementById("sNotes").value = "";
    selectedPlayers = new Set();
    renderPlayersChecks();
    toast("Cleared");
  };

  // --- Add payment ---
  document.getElementById("addPaymentBtn").onclick = () => {
    const date = document.getElementById("pDate").value || "";
    const from = document.getElementById("pFrom").value || "";
    const to = document.getElementById("pTo").value || "";
    const amount = parseFloat(document.getElementById("pAmt").value || "0");
    const notes = document.getElementById("pNotes").value || "";

    if (!date) return toast("Pick a date");
    if (!from) return toast("Select From");
    if (!PAYEES.has(to)) return toast("To must be VJ or Dhara");
    if (!(amount > 0)) return toast("Enter a valid amount");

    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2);
    state.payments.push({ id, date, from, to, amount, notes });
    saveState();

    // reset
    document.getElementById("pDate").value = "";
    document.getElementById("pTo").value = "";
    document.getElementById("pAmt").value = "";
    document.getElementById("pNotes").value = "";
    renderTables();
    toast("Payment added");
  };

  document.getElementById("clearPaymentBtn").onclick = () => {
    document.getElementById("pDate").value = "";
    document.getElementById("pTo").value = "";
    document.getElementById("pAmt").value = "";
    document.getElementById("pNotes").value = "";
    toast("Cleared");
  };

  // --- Export/Import/Wipe ---
  document.getElementById("exportBtn").onclick = () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "badminton-tracker-backup.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  document.getElementById("importBtn").onclick = async () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = async () => {
      const file = input.files[0];
      if (!file) return;
      const text = await file.text();
      try {
        const parsed = JSON.parse(text);
        if (!parsed.sessions || !parsed.payments) return toast("Invalid backup file");
        state = parsed;
        saveState();
        renderTables();
        toast("Imported");
      } catch {
        toast("Could not import file");
      }
    };
    input.click();
  };

  document.getElementById("wipeBtn").onclick = () => {
    if (!confirm("Wipe ALL data on this device?")) return;
    state = { sessions: [], payments: [] };
    saveState();
    renderTables();
    toast("Wiped");
  };

  // Defaults
  document.getElementById("sDate").value = todayISO();
  document.getElementById("pDate").value = todayISO();

  // Initial render
  render();
</script>
</body>
</html>